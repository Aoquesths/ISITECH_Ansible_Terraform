<!doctype html>
<html lang="fr">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>DevOps Dashboard — DEV — web1</title>
	<style>
		/*
			Classic dashboard layout preserved.
			Visuals only: Hollow Knight: Silksong-inspired background without using any images.
			Mood: deep blues/teals, soft moonlight glow, subtle drifting particles, gentle vignette.
		*/
		:root{
			--bg-deep:#0a0f19;      /* midnight blue */
			--bg-teal:#0f2e2e;      /* deep teal */
			--bg-emerald:#153737;   /* moss/emerald undertone */
			--card:#0f1624cc;       /* translucent dark for cards */
			--card-border:#20324dcc;/* cool border */
			--accent:#7ec2c2;       /* soft teal accent */
			--accent-2:#b2d8d8;     /* pale accent */
			--text:#e9f3f3;         /* calm near-white */
			--muted:#b6c6c6;        /* muted text */
			--success:#71d5a1;      /* gentle success */
			--warning:#ffd27a;      /* warm amber */
			--danger:#ff8e8e;       /* pastel red */
			--shadow: 0 10px 30px rgba(0,0,0,.45);
		}

		html,body{height:100%;}
		body{
			margin:0; color:var(--text); font:14px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji";
			background: radial-gradient(1200px 600px at 50% -10%, rgba(190, 240, 240, .08), transparent 60%),
									radial-gradient(800px 400px at 20% 10%, rgba(110, 200, 200, .06), transparent 60%),
									radial-gradient(900px 500px at 80% 8%, rgba(100, 160, 160, .05), transparent 60%),
									linear-gradient(180deg, var(--bg-deep) 0%, var(--bg-teal) 40%, var(--bg-emerald) 100%);
			position:relative;
			overflow-x:hidden;
		}

		/* Vignette */
		body::before{
			content:""; position:fixed; inset:0; pointer-events:none;
			background: radial-gradient(1200px 600px at 50% 0%, rgba(255,255,255,.05), rgba(0,0,0,0) 60%),
									radial-gradient(1800px 900px at 50% 120%, rgba(0,0,0,.35), rgba(0,0,0,.7) 70%);
			mix-blend-mode: screen; opacity:.9;
		}

		/* Subtle drifting “spores” */
		.spores, .spores::before, .spores::after{
			content:""; position:fixed; inset:-10% -10% -10% -10%; pointer-events:none;
			background:
				radial-gradient(2px 2px at 10% 20%, rgba(190,230,230,.25), transparent 50%),
				radial-gradient(1.5px 1.5px at 30% 70%, rgba(170,220,220,.20), transparent 50%),
				radial-gradient(2px 2px at 70% 30%, rgba(210,240,240,.22), transparent 50%),
				radial-gradient(1.5px 1.5px at 85% 60%, rgba(200,235,235,.18), transparent 50%),
				radial-gradient(2px 2px at 50% 85%, rgba(160,210,210,.16), transparent 50%);
			animation: drift 28s linear infinite;
			filter: blur(.2px) drop-shadow(0 0 3px rgba(180, 230, 230, .12));
		}
		.spores::before{ animation-duration: 38s; opacity:.6; filter: blur(.3px) drop-shadow(0 0 2px rgba(180,230,230,.10)); }
		.spores::after{ animation-duration: 46s; opacity:.45; filter: blur(.4px) drop-shadow(0 0 2px rgba(180,230,230,.08)); }
		@keyframes drift{ from{ transform: translateY(0) } to{ transform: translateY(-6%) } }

		header{ padding:28px 24px 10px; position:relative; z-index:1; }
		.title{ display:flex; align-items:baseline; gap:14px; flex-wrap:wrap; }
		.title h1{ margin:0; font-size:28px; letter-spacing:.4px; text-shadow:0 2px 14px rgba(0,0,0,.35); }
		.env-pill{
			padding:4px 10px; border:1px solid var(--card-border); border-radius:999px;
			background: linear-gradient(180deg, rgba(30,50,60,.7), rgba(15,25,35,.7));
			color:var(--accent-2); box-shadow: var(--shadow);
		}
		.meta{ color:var(--muted); font-size:12px; margin-top:4px; }

		.container{ padding:10px 24px 40px; position:relative; z-index:1; }
		.grid{
			display:grid; gap:18px; grid-template-columns: repeat(12, 1fr);
		}
		.card{
			background: var(--card); border:1px solid var(--card-border); border-radius:12px; box-shadow: var(--shadow);
			padding:16px; backdrop-filter: blur(4px);
		}
		.kpis .card h3{ margin:0 0 10px; font-size:13px; color:var(--accent-2); font-weight:600; letter-spacing:.3px; }
		.kpi-value{ font-size:22px; font-weight:700; }
		.good{ color:var(--success) } .warn{ color:var(--warning) } .bad{ color:var(--danger) }

		table{ width:100%; border-collapse:collapse; font-size:13px; }
		th, td{ text-align:left; padding:8px 10px; border-bottom:1px solid rgba(255,255,255,.06); }
		th{ color:var(--accent-2); font-weight:600; }
		tbody tr:hover{ background: rgba(255,255,255,.03); }

		.two-col{ display:grid; grid-template-columns: 1.2fr .8fr; gap:18px; }
		@media (max-width: 980px){ .grid{ grid-template-columns: 1fr } .two-col{ grid-template-columns:1fr } }

		.footer{ color:var(--muted); font-size:12px; margin-top:14px; display:flex; justify-content:space-between; align-items:center; }
		.clock{ font-variant-numeric: tabular-nums; letter-spacing:.5px; }
		.credit{ opacity:.9 }

		/* Small accent divider */
		.divider{ height:1px; background: linear-gradient(90deg, transparent, rgba(190, 240, 240, .25), transparent); margin:10px -4px; }
	</style>
</head>
<body>
	<div class="spores" aria-hidden="true"></div>

	<header>
		<div class="title">
			<h1>DevOps Dashboard</h1>
			<span class="env-pill">Env: dev · Host: web1</span>
		</div>
		<div class="meta">
			OS: GNU/Linux  · Kernel: 
		</div>
		<div class="divider"></div>
	</header>

	<main class="container">
		<!-- KPIs row -->
		<section class="grid kpis">
			<div class="card" style="grid-column: span 3;">
				<h3>Active Connections</h3>
				<div class="kpi-value" id="kpi-conns">—</div>
			</div>
			<div class="card" style="grid-column: span 3;">
				<h3>HTTP Ping</h3>
				<div class="kpi-value" id="kpi-ping">—</div>
			</div>
			<div class="card" style="grid-column: span 3;">
				<h3>Environment</h3>
				<div class="kpi-value">DEV</div>
			</div>
			<div class="card" style="grid-column: span 3;">
				<h3>Server</h3>
				<div class="kpi-value">web1</div>
			</div>
		</section>

		<section class="two-col" style="margin-top: 6px;">
			<!-- Left: Network + Software -->
			<div class="grid" style="grid-template-columns:1fr;">
				<div class="card">
					<h3 style="margin:0 0 6px; color:var(--accent-2)">Network</h3>
					<table>
						<thead><tr><th>Hostname</th><th>Primary IP</th><th>Domain</th></tr></thead>
						<tbody>
							<tr>
								<td>web1</td>
								<td>127.0.0.1</td>
								<td>local</td>
							</tr>
						</tbody>
					</table>
				</div>
				<div class="card">
					<h3 style="margin:0 0 6px; color:var(--accent-2)">Software</h3>
					<table>
						<thead><tr><th>Component</th><th>Value</th></tr></thead>
						<tbody>
							<tr><td>OS</td><td>GNU/Linux </td></tr>
							<tr><td>Kernel</td><td></td></tr>
							<tr><td>Web Server</td><td>nginx</td></tr>
						</tbody>
					</table>
				</div>
			</div>

			<!-- Right: Live Metrics -->
			<div class="grid" style="grid-template-columns:1fr;">
				<div class="card">
					<h3 style="margin:0 0 6px; color:var(--accent-2)">Live metrics</h3>
					<p style="margin:6px 0 12px; color:var(--muted)">Updated every 3s from <code>/nginx_status</code> and <code>/ping</code>.</p>
					<div style="display:flex; gap:14px; align-items:center;">
						<div>
							<div style="font-size:12px; color:var(--muted)">Active</div>
							<div id="lm-active" style="font-size:18px; font-weight:700">—</div>
						</div>
						<div>
							<div style="font-size:12px; color:var(--muted)">Ping</div>
							<div id="lm-ping" style="font-size:18px; font-weight:700">—</div>
						</div>
					</div>
					<div id="lm-status" style="margin-top:10px; font-size:12px; color:var(--muted)">Awaiting first sample…</div>
				</div>

				<div class="card">
					<h3 style="margin:0 0 6px; color:var(--accent-2)">Inventory</h3>
					<ul style="margin:0; padding-left:18px;">
						<li>Env: dev</li>
						<li>Host: web1</li>
						<li>Domain: local</li>
					</ul>
				</div>
			</div>
		</section>

			<div class="footer">
				<div class="clock" id="clock">—</div>
				<div class="credit">by Aoquesths</div>
			</div>
	</main>

	<script>
		// Real-time clock
		function updateClock(){
			const el = document.getElementById('clock');
			const now = new Date();
			const pad = (n)=> String(n).padStart(2,'0');
			el.textContent = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} `+
											 `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
		}
		updateClock(); setInterval(updateClock, 1000);

		// Live metrics (nginx stub_status + ping)
		async function getActiveConns(){
			try{
				const res = await fetch('/nginx_status', { cache:'no-store' });
				const txt = await res.text();
				// Expect first line like: "Active connections: 1"
				const m = txt.match(/Active connections:\s+(\d+)/i);
				return m ? parseInt(m[1],10) : null;
			}catch(e){ return null; }
		}
		async function ping(){
			const t0 = performance.now();
			try{
				const res = await fetch('/ping', { cache:'no-store' });
				const t = performance.now() - t0;
				return res.ok ? Math.round(t) : null;
			}catch(e){ return null; }
		}
				// Chart data store for realtime metric (ping ms or active connections)
				const chartMaxPoints = 100; // keep last 100 samples
				const dataSeries = [];
				let metricType = 'ping'; // 'ping' | 'active'

				function pushSample(val){
					const t = Date.now();
					dataSeries.push({ t, v: val });
					while(dataSeries.length > chartMaxPoints) dataSeries.shift();
				}

			function drawChart(){
				const c = document.getElementById('rt-chart');
				if(!c) return;
				const dpr = window.devicePixelRatio || 1;
				const style = getComputedStyle(c);
				const w = c.clientWidth;
				const h = c.clientHeight;
				c.width = Math.max(300, w) * dpr;
				c.height = Math.max(150, h) * dpr;
				const ctx = c.getContext('2d');
				ctx.scale(dpr, dpr);
				// background glow
				ctx.clearRect(0,0,c.width,c.height);
				const width = c.width/dpr, height = c.height/dpr;
				ctx.fillStyle = 'rgba(255,255,255,0.02)';
				ctx.fillRect(0,0,width,height);
				// axes
				const pad = 28;
				const plotW = width - pad*2;
				const plotH = height - pad*2;
				ctx.strokeStyle = 'rgba(190,240,240,0.2)';
				ctx.lineWidth = 1;
				ctx.beginPath();
				ctx.moveTo(pad, height - pad);
				ctx.lineTo(width - pad, height - pad);
				ctx.moveTo(pad, pad);
				ctx.lineTo(pad, height - pad);
				ctx.stroke();
				// grid
				ctx.strokeStyle = 'rgba(255,255,255,0.06)';
				for(let i=1;i<4;i++){
					const y = pad + i*(plotH/4);
					ctx.beginPath(); ctx.moveTo(pad, y); ctx.lineTo(width-pad, y); ctx.stroke();
				}
				// series
				if(dataSeries.length === 0) return;
				const xs = dataSeries.map(p=>p.t);
				const ys = dataSeries.map(p=>p.v==null?0:p.v);
				const tMin = xs[0], tMax = xs[xs.length-1] || tMin+1;
				const vMin = 0;
				const vMax = Math.max(50, Math.max.apply(null, ys.filter(v=>Number.isFinite(v))) || 0);
				ctx.beginPath();
				ctx.lineWidth = 2;
				ctx.strokeStyle = '#7ec2c2';
				ctx.shadowColor = 'rgba(126,194,194,0.35)';
				ctx.shadowBlur = 6;
						dataSeries.forEach((p,i)=>{
					const x = pad + (plotW * (p.t - tMin) / (tMax - tMin || 1));
					const y = height - pad - (plotH * ((p.v||0) - vMin) / (vMax - vMin || 1));
					if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
				});
				ctx.stroke();
				ctx.shadowBlur = 0;
				// label
				ctx.fillStyle = 'rgba(255,255,255,0.6)';
				ctx.font = '12px system-ui, sans-serif';
						const label = metricType === 'ping' ? 'Ping (ms) — realtime' : 'Active connections — realtime';
						ctx.fillText(label, pad, pad-8);
			}

			async function sample(){
			const [conns, p] = await Promise.all([getActiveConns(), ping()]);
			const connsEl = document.getElementById('kpi-conns');
			const pingEl = document.getElementById('kpi-ping');
			const lmA = document.getElementById('lm-active');
			const lmP = document.getElementById('lm-ping');
			const statusEl = document.getElementById('lm-status');
			if(conns !== null){ connsEl.textContent = conns; lmA.textContent = conns; }
			else { connsEl.textContent = '—'; lmA.textContent = '—'; }
			if(p !== null){ pingEl.textContent = p + ' ms'; lmP.textContent = p + ' ms'; }
			else { pingEl.textContent = '—'; lmP.textContent = '—'; }
			const t = new Date().toLocaleTimeString();
			statusEl.textContent = `Last update ${t}`;
						// push to chart based on selected metric
						const sampleVal = metricType === 'ping' ? (p == null ? 0 : p) : (conns == null ? 0 : conns);
						pushSample(sampleVal);
				drawChart();
		}
			function resize(){ drawChart(); }
			window.addEventListener('resize', resize);
			sample(); setInterval(sample, 3000);
	</script>

		<!-- Bottom realtime chart section -->
		<section class="container" style="position:relative; z-index:1; margin-top:4px;">
				<div class="card" style="height:260px;">
					<div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
						<h3 style="margin:0 0 6px; color:var(--accent-2)">Realtime metric</h3>
						<label style="font-size:12px; color:var(--muted); display:flex; align-items:center; gap:6px;">
							Metric:
							<select id="metric-picker" style="padding:4px 8px; background:#0f1624; color:#e9f3f3; border:1px solid #20324dcc; border-radius:6px;">
								<option value="ping" selected>Ping (ms)</option>
								<option value="active">Active connections</option>
							</select>
						</label>
					</div>
					<p style="margin:6px 0 10px; color:var(--muted)">Visualise ping ou connexions actives (maj toutes les 3s).</p>
				<div style="position:relative; width:100%; height:170px;">
					<canvas id="rt-chart" style="width:100%; height:100%; display:block; border-radius:8px; background: rgba(255,255,255,.015);"></canvas>
				</div>
			</div>
		</section>

			<script>
				// Metric selector wiring
				(function(){
					const sel = document.getElementById('metric-picker');
					if(!sel) return;
					sel.addEventListener('change', function(){
						metricType = this.value === 'active' ? 'active' : 'ping';
						// reset series when switching metric for clarity
						dataSeries.splice(0, dataSeries.length);
						drawChart();
					});
				})();
			</script>
</body>
</html>